import tkinter as tk
from tkinter import ttk
from tkcalendar import Calendar
from datetime import datetime


class CalendarView(tk.Toplevel):
    def __init__(self, parent, task_controller):
        super().__init__(parent)

        self.title("Plantivity ~ Task Calendar")
        self.geometry("800x500")
        self.resizable(False, False)

        self.task_controller = task_controller

        #Calendar
        self.calendar = Calendar(
            self,
            selectmode="day",
            date_pattern="yyyy-mm-dd",
            showweeknumbers=False
        )
        self.calendar.grid(row=0, column=0, padx=20, pady=20)

        self.calendar.bind("<<CalendarSelected>>", self.on_date_select)

        #Task list
        right_frame = tk.Frame(self)
        right_frame.grid(row=0, column=1, padx=20, pady=20, sticky="n")

        tk.Label(
            right_frame,
            text="Tasks on Selected Date",
            font=("Helvetica", 14, "bold")
        ).pack(pady=10)

        self.task_listbox = tk.Listbox(right_frame, width=40, height=15)
        self.task_listbox.pack()

        #Back Button
        back_btn = tk.Button(
            self,
            text="Back to Dashboard",
            command=self.destroy,
            width=20
        )
        back_btn.grid(row=1, column=0, columnspan=2, pady=15)

        # Highlight dates that have tasks
        self.highlight_task_dates()

    def highlight_task_dates(self):
        self.calendar.calevent_remove('all')

        tasks = self.task_controller.get_all_tasks()

        for task in tasks:
            try:
                due_date = datetime.strptime(task.due_date, "%Y-%m-%d").date()

                if task.completion_status == "Completed":
                    self.calendar.calevent_create(
                        due_date,
                        f"{task.title}",
                        "completed"
                    )
                else:
                    self.calendar.calevent_create(
                        due_date,
                        f"{task.title}",
                        "task"
                    )

            except Exception:
                continue

        # Color settings
        self.calendar.tag_config("task", background="#ffeb3b", foreground="green")
        self.calendar.tag_config("completed", background="#ff7381", foreground="blue")

    #When user clicks a data
    def on_date_select(self, event):
        selected = self.calendar.get_date()

        self.task_listbox.delete(0, tk.END)

        tasks = self.task_controller.get_all_tasks()

        found = False
        for task in tasks:
            if task.due_date == selected:
                found = True

                display = (
                    f"Title: {task.title}\n"
                    f"Category: {task.category}\n"
                    f"Priority: {task.priority}\n"
                    f"Status: {task.completion_status}\n"
                    "--------------------------"
                )

                self.task_listbox.insert(tk.END, display)

        if not found:
            self.task_listbox.insert(tk.END, "No tasks for this date.")
