import tkinter as tk
from PIL import Image, ImageTk

class ProgressView(tk.Toplevel):
    def __init__(self, parent, controller):
        super().__init__(parent)
        self.title("Plantivity ~ Progress")
        self.geometry("700x400")

        self.controller = controller

        self.canvas = tk.Canvas(self, width=680, height=300, bg="white")
        self.canvas.pack()

        tk.Button(self, text="Refresh", command=self.refresh).pack(pady=10)

        self.load_images()
        self.refresh()

    # Load all images (stages + background)
    def load_images(self):
        def load_stage(path):
            try:
                img = Image.open(path).resize((110, 110))
                return ImageTk.PhotoImage(img)
            except:
                return None

        # Plant stages
        self.stages = [
            load_stage("sprout.png"),      # Stage 1
            load_stage("seedling.png"),    # Stage 2
            load_stage("budding.png"),     # Stage 3
            load_stage("flower.png")       # Stage 4
        ]

        # Background
        try:
            bg = Image.open("dirt.png").resize((680, 300))
            self.bg_img = ImageTk.PhotoImage(bg)
        except:
            self.bg_img = None

    # Determine stage and number of full flowers
    def calculate_stage(self):
        completed = len(self.controller.get_completed_tasks())
        if completed == 0:
            return -1, 0  # No plant yet

        # Each plant is 4 tasks (1-4: first plant, 5-8: second plant, etc.)
        stage_index = (completed - 1) % 4
        full_flowers = (completed - 1) // 4
        return stage_index, full_flowers

    def refresh(self):
        self.canvas.delete("all")

        canvas_height = 300
        canvas_width = 680

        # Draw background first
        if self.bg_img:
            self.canvas.create_image(0, 0, image=self.bg_img, anchor="nw")

        stage_index, full_flowers = self.calculate_stage()

        if stage_index == -1:
            self.canvas.create_text(
                canvas_width // 2, canvas_height // 2,
                text="Complete your first task to grow your plant!",
                font=("Arial", 14),
                fill="white"
            )
            return

        x_start = 80
        spacing = 130

        # Y-coordinate so plants grow out of dirt
        y_pos = canvas_height - 90  # tweak this number if you want them higher/lower

        # Draw all full flowers first (completed 4-task cycles)
        for i in range(full_flowers):
            if self.stages[-1]:
                self.canvas.create_image(x_start + i * spacing, y_pos, image=self.stages[-1])

        # Draw current growing plant stage
        cur_img = self.stages[stage_index]
        if cur_img:
            self.canvas.create_image(x_start + full_flowers * spacing, y_pos, image=cur_img)

