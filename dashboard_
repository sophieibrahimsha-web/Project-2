# ------------------------
# Main Dashboard UI
# ------------------------
class Dashboard:
    def __init__(self, root):
        self.root = root
        self.root.title("Plantivity Dashboard")
        self.root.geometry("1000x600")

        self.controller = TaskController()

        self.create_header()
        self.create_tree()
        self.create_buttons()
        self.refresh()

    def create_header(self):
        frame = tk.Frame(self.root)
        frame.pack(fill="x", pady=10)

        self.next_label = tk.Label(frame, text="Next Task: None", font=("Arial", 14, "bold"))
        self.next_label.pack(side="left", padx=20)

        self.progress_label = tk.Label(frame, text="Progress: 0%", font=("Arial", 14))
        self.progress_label.pack(side="right", padx=20)

    def create_tree(self):
        frame = tk.Frame(self.root)
        frame.pack(fill="both", expand=True, padx=20)

        cols = ("Title", "Description", "Category", "Due Date", "Priority", "Status")
        self.tree = ttk.Treeview(frame, columns=cols, show="headings")
        for c in cols:
            self.tree.heading(c, text=c)
            self.tree.column(c, width=150)
        self.tree.pack(fill="both", expand=True)

    def create_buttons(self):
        frame = tk.Frame(self.root)
        frame.pack(pady=10)

        tk.Button(frame, text="Add Task", width=15, command=self.add).grid(row=0, column=0, padx=10)
        tk.Button(frame, text="Edit Task", width=15, command=self.edit).grid(row=0, column=1, padx=10)
        tk.Button(frame, text="Delete Task", width=15, command=self.delete).grid(row=0, column=2, padx=10)
        tk.Button(frame, text="Calendar", width=15, command=self.open_calendar).grid(row=0, column=3, padx=10)
        tk.Button(frame, text="Progress", width=15, command=self.open_progress).grid(row=0, column=4, padx=10)

    def refresh(self):
        self.tree.delete(*self.tree.get_children())
        for t in self.controller.get_all_tasks():
            self.tree.insert("", "end", values=(t.title, t.description, t.category, t.due_date, t.priority, t.completion_status))

        nxt = self.controller.get_next_task()
        if nxt:
            self.next_label.config(text=f"Next Task: {nxt.title}")
        else:
            self.next_label.config(text="Next Task: None")

        pct = self.controller.get_completion_percentage()
        self.progress_label.config(text=f"Progress: {pct}%")

    def get_selected_title(self):
        sel = self.tree.selection()
        if not sel:
            return None
        return self.tree.item(sel[0])["values"][0]

    # CRUD actions
    def add(self):
        TaskPopup(self, mode="add")

    def edit(self):
        title = self.get_selected_title()
        if not title:
            messagebox.showwarning("Select task", "Please select a task to edit.")
            return
        for t in self.controller.get_all_tasks():
            if t.title == title:
                TaskPopup(self, mode="edit", task_obj=t)
                return

    def delete(self):
        title = self.get_selected_title()
        if not title:
            messagebox.showwarning("Delete Task", "Select a task first.")
            return
        if messagebox.askyesno("Delete", f"Delete '{title}'?"):
            self.controller.delete_task(title)
            self.refresh()

    def open_calendar(self):
        CalendarView(self.root, self.controller)

    def open_progress(self):
        ProgressView(self.root, self.controller)


# ------------------------
# Task Popup (Add/Edit)
# ------------------------
class TaskPopup:
    def __init__(self, dashboard, mode, task_obj=None):
        self.dashboard = dashboard
        self.controller = dashboard.controller
        self.mode = mode
        self.task_obj = task_obj

        self.win = tk.Toplevel()
        self.win.title("Add Task" if mode == "add" else "Edit Task")
        self.win.geometry("400x450")

        # fields
        tk.Label(self.win, text="Title").pack()
        self.title_entry = tk.Entry(self.win, width=40)
        self.title_entry.pack()

        tk.Label(self.win, text="Description").pack()
        self.desc_entry = tk.Entry(self.win, width=40)
        self.desc_entry.pack()

        tk.Label(self.win, text="Category").pack()
        self.cat_box = ttk.Combobox(self.win, values=category_options)
        self.cat_box.pack()

        tk.Label(self.win, text="Due Date").pack()
        self.date_entry = DateEntry(self.win, date_pattern="yyyy-mm-dd")
        self.date_entry.pack()

        tk.Label(self.win, text="Priority").pack()
        self.pri_box = ttk.Combobox(self.win, values=priority_options)
        self.pri_box.pack()

        tk.Label(self.win, text="Status").pack()
        self.status_box = ttk.Combobox(self.win, values=completion_options)
        self.status_box.pack()

        tk.Button(self.win, text="Save", command=self.save).pack(pady=20)

        if mode == "edit":
            self.load()

    def load(self):
        t = self.task_obj
        self.title_entry.insert(0, t.title)
        self.desc_entry.insert(0, t.description)
        self.cat_box.set(t.category)
        self.date_entry.set_date(t.due_date)
        self.pri_box.set(t.priority)
        self.status_box.set(t.completion_status)

    def save(self):
        new = Task(
            title=self.title_entry.get(),
            description=self.desc_entry.get(),
            category=self.cat_box.get(),
            due_date=self.date_entry.get(),
            priority=self.pri_box.get(),
            completion_status=self.status_box.get()
        )

        if self.mode == "add":
            self.controller.add_task(new)
        else:
            self.controller.update_task(self.task_obj, new)

        self.dashboard.refresh()
        self.win.destroy()
